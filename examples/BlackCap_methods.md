## Results

### Construction of a population-based brain template
Our goal was to create a brain template that represents the population as a whole, without bias toward the unique features of any single individual. To accomplish this, we used the symmetric group-wise normalization (SyGN) algorithm (Brian B. Avants et al. 2010; Fonov et al. 2011), a method commonly employed in magnetic resonance imaging (MRI) to generate high-quality, unbiased average templates for both human (Brian B. Avants et al. 2010) and animal brains (Love et al. 2016; Seidlitz et al. 2018; Jung et al. 2021; Liu et al. 2021).

The SyGN algorithm works by iteratively registering and averaging multiple individual brain images to a common target space. This process begins with an initial template image, which is refined through successive iterations in both intensity and shape, ultimately converging on an unbiased average representation. The final template benefits from the increased signal-to-noise ratio achieved through averaging while avoiding blurring, thereby preserving fine anatomical details (Brian B. Avants et al. 2010).

Here we constructed a brain template using the 10 blackcap brain image stacks acquired via STP tomography. The images were prepared by cropping, downsampling to a 25 µm isotropic resolution, and correcting for intensity inhomogeneities. Each image was divided into left and right hemispheres, and symmetric images were created by mirroring each hemisphere. After excluding two damaged hemispheres, we were left with 18 left-right symmetric brain images, which were used as inputs for four iterations of the SyGN algorithm. This approach ensured left-right symmetry in the resulting template, which is crucial for certain applications. For instance, asymmetric templates cannot be used to estimate left-right anatomical differences in a population, as any observed differences may be confounded by the inherent asymmetry of the template itself (Fonov et al. 2011). Further details on image preparation and template construction using SyGN can be found in the Methods section.

The final template generated by this process is shown in Figure 3, juxtaposed with individual images that contributed to its construction.

## Methods

### Preparation of images for template construction
We used the set of 10 blackcap brain image stacks obtained through STP tomography. We visually inspected the data to select channels with a good signal-to-noise ratio and clear contrast between gray and white matter structures. In 8/10 cases, we used the green autofluorescence channel, while in the remaining 2/10 cases, we used the blue channel.

We manually cropped each image to tightly enclose the brain tissue and downsampled them to an isotropic resolution of 25 µm. The images were reoriented to conform to BrainGlobe's ASR convention—placing the origin at the anterior superior right corner and ordering the axes as anterior-posterior, superior-inferior, and right-left (Claudi et al. 2020). The reoriented images were then converted from TIFF to NIfTI format for compatibility with the Advanced Normalization Tools (ANTs) software suite (Tustison et al. 2021). To correct for intensity inhomogeneities, ANTs' N4 bias field correction function was applied (Tustison et al. 2010). Brain masks were generated using a combination of functions from the scikit-image package (Walt et al. 2014). The images were blurred with a Gaussian kernel (standard deviation of 150 µm) and thresholded using the 'triangle' method. The largest connected component was selected from the thresholded mask, and binary closing was applied with a square footprint of 250 µm to eliminate small holes.

To ensure symmetry and exclude two damaged hemispheres, we virtually hemisected each brain image along the mid-sagittal plane. This was achieved by:
- Defining the mid-sagittal plane in one image by using napari (Ahlers et al. 2023) to annotate multiple midline points and fitting a 2D plane.
- Rotating this image in 3D so its mid-sagittal plane aligned with the central sagittal plane of the image volume.
- Rigidly aligning each individual image to this rotated target using ANTs registration, ensuring consistent alignment of the mid-sagittal plane across subjects.
- Splitting aligned images into left and right hemispheres along the mid-sagittal plane, and discarding the two damaged hemispheres.
- Mirroring the 18 intact hemispheres along the left-right axis to   generate symmetric images.

These steps produced 18 symmetric brain images and their corresponding masks, ready for template construction.

### Iterative Template Construction with SyGN

The symmetric brain images and their masks served as inputs to the symmetric group-wise normalization (SyGN) algorithm for unbiased average template construction (Brian B. Avants et al. 2010). The brain masks were employed during registration to focus computations within brain areas and exclude background.

SyGN is canonically implemented in the open-source toolkit Advanced Normalization Tools (ANTs) (Tustison et al. 2021) through the antsMultivariateTemplateConstruction2.sh script. Here we used ANTs v2.5.2 in conjunction with an optimized implementation of the template construction script, which offers enhanced features such as the ability to resume interrupted computations and automatic adjustment of registration parameters based on input image size and resolution. Template construction was initialized using one of the input images as a starting template and executed in four stages with progressively higher-order transformation types: rigid (6 parameters), similarity (6 rigid parameters plus 1 uniform scaling), affine (12 parameters), and non-linear. The non-linear stage relied on  ANTs' symmetric diffeomorphic normalization (B. B. Avants et al. 2008), which is among the top-performing algorithms for non-linear image registration (Klein et al. 2009). Each stage was passed through four iterations of the SyGN algorithm. Briefly, each SyGN iteration involved the following steps (see also Supplementary Figure):
1. Register each individual subject to the current template using linear and/or non-linear transformations (depending on the stage).
2. Transform the individual images to the current template space using the computed matrices and/or nonlinear deformation fields.
3. Calculate the voxel-wise mean of the transformed images and apply a sharpening filter to the resulting average intensity image.
4. Average the individual-to-template transformations from step 1 to obtain an average transformation, then invert it.
5. Apply the inverted average transformation from step 4 to the sharpened average intensity image from step 3. This step updates the template's shape to more closely reflect the average shape of the individual brains. The updated template becomes the new registration target for the next iteration.

The 16 average images from each stage and iteration were visually inspected to ensure convergence to a stable template (see Supplementary Figure). The final template, generated after the 4th iteration of the non-linear stage, was selected as the reference image for the blackcap brain atlas.
